---
title: "Electronic Medical Data in SPARC IBD and IBD QOrus"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{emr-data-in-sparc}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(rmarkdown.html_vignette.check_title = FALSE)
```

Two studies in IBD Plexus have integrated electronic medical record (EMR) data:

1.  A Study of a Prospective Adult Research Cohort with Inflammatory Bowel Disease (SPARC IBD) is a longitudinal study following adult IBD patients as they receive care at 17 different sites across the United States. To learn more about SPARC IBD and it's development please see [The Development and Initial Findings of A Study of a Prospective Adult Research Cohort with Inflammatory Bowel Disease (SPARC IBD)] ([https://doi.org/10.1093/ibd/izab071).](https://doi.org/10.1093/ibd/izab071).)

2.  IBD Qorus is a prospective cohort focused on improving the quality of care for patients with IBD. Currently there are over 30 sites enrolling patients across the United States. To learn more about IBD Qorus please see <https://www.crohnscolitisfoundation.org/research/ibd-qorus>.

This vignette details the functions built into the ibdplexus package to help navigate the EMR data for these two studies.

```{r setup}
library(ibdplexus, quietly = T)
library(tidyr, quietly = T)
library(dplyr, quietly = T)
library(lubridate, quietly = T)
```

# Calculating BMI

`calculate_bmi()` filters the observations_emr domain to find the weight and height of a patient. Weight is converted to kg and height is converted to meters. For patients with more than one BMI, outliers are removed. This function produces a long data.frame with one row per patient BMI.

In the `sparc_summary()` function, this data.frame is cut to find the BMI closest to the specified index date.

Future versions of this package will include a similar functionality for a Qorus summary table.

# Extracting Diagnosis Codes from the EMR

`emr_extract_diagnosis()` filters the diagnosis and patient_problem table based on specified inclusion and exclusion criteria. One may search for comorbidities, general disease complications, common symptoms, extra-intestinal manifestations, cancer, common clinical trial criteria, and infectious diseases. There is also an option to custom input ICD10 codes. The result is a list of data.frames with all relevant EMR ICD10 diagnosis and/or patient problem records.

The list of pre-programmed ICD10 codes is pasted below. Full documentation for this function can be found here: inst/userguides/Diagnosis_EMR_Extract.md.

| Condition Categories                     | ICD 10 Diagnosis Codes                                                                                                                                                                                         | ICD 9 Diagnosis Codes                                                                                                       |
|---------------|------------------------------------|---------------------|
| SYSTEMIC FUNGAL INFECTION                | B39, B45, B38, B40, B46, B44, B37, B59                                                                                                                                                                         | 110-118                                                                                                                     |
| CANCER                                   | All C codes, d0, d1, d2, d3, d4                                                                                                                                                                                | 140-229                                                                                                                     |
| COLORECTAL CANCER                        | C18, C19, C20                                                                                                                                                                                                  | 153, 154.0, 154.1                                                                                                           |
| CERVIX CARCINOMA                         | D06                                                                                                                                                                                                            | 233.1                                                                                                                       |
| SKIN CARCINOMA                           | C44.01, C44.02, C44.11, C44.12, C44.21, C44.22, C44.31, C44.32, C44.41, C44.42, C44.51, C44.52, C44.61, C44.62, C44.71, C44.72, C44.81, C44.82, C44.91, C44.92                                                 | 232                                                                                                                         |
| STOMA                                    | L24.B0, L24.B1, L24.B3, Z93.3, Z93.2                                                                                                                                                                           | V44.2, V44.3                                                                                                                |
| DEMYELINATING DISORDER                   | G35, G36, G37                                                                                                                                                                                                  | 340, 341                                                                                                                    |
| CELIAC                                   | K90.0                                                                                                                                                                                                          | 579.0                                                                                                                       |
| PSC                                      | K83.01                                                                                                                                                                                                         | 576.1                                                                                                                       |
| GI BLEEDING                              | K92.1                                                                                                                                                                                                          | 569.3, 578.1, 599.70, 777.3, 792.1                                                                                          |
| GI ULCER                                 | K25, K27, K28, K26, K63.3, K62.6                                                                                                                                                                               | 531-534                                                                                                                     |
| PERIANAL ABSCESS OR FISTULA              | K50.913, K50.914, K50.813, K50.814, K50.013, K50.014, K50.113, K50.114, K51.013, K51.014, K51.213, K51.214, K51.313, K51.314, K51.413, K51.414, K51.513, K51.514, K51.813, K51.814, K51.913, K51.914, K60, K61 | 565.1, 566                                                                                                                  |
| WEIGHT LOSS                              | R63.4                                                                                                                                                                                                          | 783.1, 783.2                                                                                                                |
| B2 OR B3                                 | K50.912, K50.112, K50.012, K50.812                                                                                                                                                                             | 560.89, 560.9                                                                                                               |
| MALNOURISHMENT                           | E4                                                                                                                                                                                                             | 263.9, 269.9                                                                                                                |
| ANEMIA                                   | D50, D51, D52, D53                                                                                                                                                                                             | 280-281                                                                                                                     |
| DIARRHEA                                 | R19.7, K59.1, K58.0                                                                                                                                                                                            | 564.5, 787.91                                                                                                               |
| NAUSEA OR VOMITING                       | R11                                                                                                                                                                                                            | 787.0                                                                                                                       |
| HYPOALBUMINEMIA                          | E88.09                                                                                                                                                                                                         | 273.8                                                                                                                       |
| FEVER                                    | R50.9, R61                                                                                                                                                                                                     | 780.6                                                                                                                       |
| ABDOMINAL PAIN                           | R10                                                                                                                                                                                                            | 789.0                                                                                                                       |
| CDI                                      | A04.7                                                                                                                                                                                                          | 008.45                                                                                                                      |
| ARTHRITIS OR LOW BACK PAIN               | M13, M05, M06, M07, M08, M10, M11, M12, M14, M1A, ( need to add M54.5)                                                                                                                                         | 710-716, 724.2                                                                                                              |
| DACTYLITIS                               | L08.9                                                                                                                                                                                                          | 686.9                                                                                                                       |
| NON UC IBD DIAGNOSIS                     | K50, K52.3, K52.83, K55.9                                                                                                                                                                                      | 555, 558.9                                                                                                                  |
| TOXIC MEGACOLON                          | K59.31                                                                                                                                                                                                         | 564.7                                                                                                                       |
| FULMINANT COLITIS                        | K55.03                                                                                                                                                                                                         | 557.0                                                                                                                       |
| INTRAABDOMINAL ABSCESS                   | L02.211, K65.1                                                                                                                                                                                                 | 567.22, 682.2                                                                                                               |
| STRICTURE STENOSIS                       | K56.69                                                                                                                                                                                                         | 560.89                                                                                                                      |
| COLON ADENOMA                            | D12.2, D12.3, D12.4, D12.5, D12.6, K31.A2, K55.20                                                                                                                                                              | 211.3, 235.2                                                                                                                |
| INFECTION                                | L0, A49, A0 (need to refine and add B99)                                                                                                                                                                       | 001-009,130-136                                                                                                             |
| TUBERCULOSIS                             | A15, A17, A18, A19                                                                                                                                                                                             | 010-018                                                                                                                     |
| DIABETES                                 | E08, E09, E10, E11, E13                                                                                                                                                                                        | 250                                                                                                                         |
| HYPERTENSION                             | I10, I11, I12, I13, I15, I16                                                                                                                                                                                   | 401-405                                                                                                                     |
| COPD                                     | J44                                                                                                                                                                                                            | 491.21, 493.2, 496                                                                                                          |
| CKD STAGE IIB OR MORE                    | N18.32, N18.4, N18.5                                                                                                                                                                                           | 585.2-585.5                                                                                                                 |
| UNSTABLE ANGINA OR MYOCARDIAL INFARCTION | I20, I21                                                                                                                                                                                                       | 410, 412, 413                                                                                                               |
| AUTOIMMUNE INFLAMMATORY DISEASE          | M05, M06, M3, M04                                                                                                                                                                                              | 714, 710                                                                                                                    |
| HEPATITIS B                              | B16, B18.0, B18.1, B19.1                                                                                                                                                                                       | 070.2, 070.3                                                                                                                |
| HEPATITIS C                              | B17.1, B18.2, B19.2                                                                                                                                                                                            | 070.41, 070.44, 070.51, 070.54, 070.7                                                                                       |
| INHERITED AUTOIMMUNE DISORDER            | D80.0, D82.0, D80.4, D82.3, N41.4, Q82.8, D81.0, D81.1, D81.2, D81.3, E70.330, D76.1, D82.4, D82.2, D81.6, D81.7, D83, D80.2, D84.1, G11.3, D81.5, D81.8                                                       | 279.04, 279.12, 279.02, 279.8, 601.8, 757.2, 757.39, 279.2, 270.2, 288.4, 279.8, 279.06, 279.01, 277.6, 334.8, 277.2, 266.2 |
