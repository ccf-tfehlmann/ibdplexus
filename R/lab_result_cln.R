#' lab_result_cln
#'
#' A function to clean the "Test Unit" and "Lab Results" fields in in the Lab EMR table to standard formats for analysis.
#'
#'
#' @param data A single dataframe with lab EMR records, from a list of dataframes, typically generated by a call to load_data. See example for extracting the lab EMR table from the load_data results.
#'
#'
#' @return A modified patient list with all specified indicators.
#' @export
#'
#' @examples
#'
#' #example for cleaning a lab EMR table starting with a list of dataframes, typically generated by a call to load_data
#'
#' data = load_data(datadir="C:/Users/me/",domains="Labs",data_type="EMR")
#' #labemr = data$labs
#' #cleanedlabemr = lab_result_cln(labdata)



lab_result_cln <- function(labemrdata){
  labemrdata %>%
    mutate(lab_result_cln=ifelse(round(parse_number(LAB_RESULTS),digits=3)==round(parse_number(TEST_RESULT_NUMERIC),digits=3),round(parse_number(TEST_RESULT_NUMERIC),digits=3),
                                 ifelse(grepl("<",LAB_RESULTS,ignore.case=TRUE),"LOWER LIMIT",
                                        ifelse(grepl(">",LAB_RESULTS,ignore.case=TRUE),"UPPER LIMIT",
                                               ifelse(grepl("negative",LAB_RESULTS,ignore.case=TRUE),"NEGATIVE",
                                                      ifelse(grepl("positive",LAB_RESULTS,ignore.case=TRUE),"POSITIVE",
                                                             ifelse(grepl("indeterminate",LAB_RESULTS,ignore.case=TRUE),"INDETERMINATE",
                                                                    ifelse(grepl("^0+$",LAB_RESULTS,ignore.case=TRUE),"0",LAB_RESULTS)))))))) %>%
    mutate(test_unit_cln1=toupper(TEST_UNIT)) %>%
    mutate(test_unit_cln2=ifelse(test_unit_cln1 %in% c("SEC","SEC.","SECOND","SECOND(S)","SECONDS","SECS","SECS."),"SECONDS",
                                 ifelse(test_unit_cln1 %in% c("SEE NOTE","SEE NOTE."),"SEE NOTE",
                                        ifelse(test_unit_cln1 %in% c("UG/24 HR","UG/24 HRS","UG/24H","UG/24HR","UG/24HRS","UG/DAY"),"UG/DAY",
                                               ifelse(test_unit_cln1 %in% c("RATIO","RATIO UNITS"),"RATIO",
                                                      ifelse(test_unit_cln1 %in% c("PH","PH UNITS"),"PH",
                                                             ifelse(test_unit_cln1 %in% c("MG/L","MGL","MILLIGRAMS PER LITER"),"MG/L",
                                                                    ifelse(test_unit_cln1 %in% c("MG/DL","MGDL"),"MG/DL",
                                                                           ifelse(test_unit_cln1 %in% c("OD UNIT","OD UNITS"),"OD UNITS",
                                                                                  ifelse(test_unit_cln1 %in% c("MOSM/KG WATER","MOSM/KG H2O","MOSM/KG_H2O"),"MOSM/KG WATER",
                                                                                         ifelse(test_unit_cln1 %in% c("U/G HB","U/GHB"),"U/G HB",
                                                                                                ifelse(test_unit_cln1 %in% c("PMOL","PMOLE"),"PMOL",
                                                                                                       ifelse(test_unit_cln1 %in% c("MPL U/ML","MPL-U/ML"),"MPL U/ML",
                                                                                                              ifelse(test_unit_cln1 %in% c("MPL","MPL UNITS","MPL UNIT(S)"),"MPL",
                                                                                                                     ifelse(test_unit_cln1 %in% c("NG/ML/H","NG/ML/HR"),"NG/ML/HR",
                                                                                                                            ifelse(test_unit_cln1 %in% c("UNIT/L","UNITS/L","UNIT(S)/L"),"UNITS/L",
                                                                                                                                   ifelse(test_unit_cln1 %in% c("THOU/UL","THOUSAND/UL","THOUS/MCL","THOU/MCL","THO/UL","TH/UL"),"THO/UL",
                                                                                                                                          ifelse(test_unit_cln1 %in% c("UG/ML{FEU}","UG/ML FEU","UG/MLFEU"),"UG/ML{FEU}",
                                                                                                                                                 ifelse(test_unit_cln1 %in% c("MM/1 H","MM/1HR","MM/H","MM/HOUR","MM/HR","MM/HR(S)","MM/HR."),"MM/HR",
                                                                                                                                                        ifelse(test_unit_cln1 %in% c("THOU /CU MM","THOU/CU MM","THOU/CUMM","THSD/CUMM","TH/CUMM"),"THOU/CU MM",
                                                                                                                                                               ifelse(test_unit_cln1 %in% c("THOUS/CMM","THDS/CMM","TH/CMM"),"TH/CMM",
                                                                                                                                                                      ifelse(test_unit_cln1 %in% c("UNIT","UNIT(S)","UNITS"),"UNITS",
                                                                                                                                                                             ifelse(test_unit_cln1 %in% c("UNIT/L","UNITS/L","UNITS PER LITER"),"UNITS/L",
                                                                                                                                                                                    ifelse(test_unit_cln1 %in% c("UNIT/ML","UNITS/ML","UNITS PER MILLILITER"),"UNITS/ML",
                                                                                                                                                                                           ifelse(test_unit_cln1 %in% c("UNKNOWN","UNK"),"UNKNOWN",
                                                                                                                                                                                                  ifelse(test_unit_cln1 %in% c("MG/GM","MG/GRAMS"),"MG/GM",
                                                                                                                                                                                                         ifelse(test_unit_cln1 %in% c("LBS","LBS."),"LBS",
                                                                                                                                                                                                                ifelse(test_unit_cln1 %in% c("MCL","MICROLITERS"),"MCL",
                                                                                                                                                                                                                       ifelse(test_unit_cln1 %in% c("ML","MILLILITER"),"ML",
                                                                                                                                                                                                                              ifelse(test_unit_cln1 %in% c("VOL %","VOL%"),"VOL %",
                                                                                                                                                                                                                                     ifelse(test_unit_cln1 %in% c("WEEKS","WEEK(S)","WK"),"WEEKS",
                                                                                                                                                                                                                                            ifelse(test_unit_cln1 %in% c("MILLION/ML","MIL/ML","MILLIONS/ML","MILLN/ML"),"MIL/ML",
                                                                                                                                                                                                                                                   ifelse(test_unit_cln1 %in% c("MIL","MILLION","MILLION(S)","MILLIONS"),"MILLIONS",
                                                                                                                                                                                                                                                          ifelse(test_unit_cln1 %in% c("MIN","MIN.","MINS","MINUTE","MINUTE(S)","MINUTES"),"MIN",
                                                                                                                                                                                                                                                                 ifelse(test_unit_cln1 %in% c("MIL/MCL","MIL/UL","MILL/MCL","MILLION/UL","MILLION/MCL","MILL/UL"),"MIL/UL",
                                                                                                                                                                                                                                                                        ifelse(test_unit_cln1 %in% c("X(10)3","X 10 3","X10(3)","X10^3","X1000","X 1000","X10E3","X10E+03","X10E*3"),"X(10)3",
                                                                                                                                                                                                                                                                               ifelse(test_unit_cln1 %in% c("X(10)6","X 10 6","X10(6)","X10^6","X10E6","X10E+06","X10E*6","X1000000"),"X(10)6",
                                                                                                                                                                                                                                                                                      ifelse(test_unit_cln1 %in% c("X 10","X10"),"X10",
                                                                                                                                                                                                                                                                                             ifelse(test_unit_cln1 %in% c("X 10*3/UL","X 10(3)/MCL","X 10^3/UL","X(10)3/UL","X 1000/UL","X10 3/UL","X10(3)/MCL","X10(3)/UL","X10^3/UL","X1000/UL","X10E3/UL","X10E+03/UL","X10*3/UL","X10*3/MCL"),"X10*3/UL",
                                                                                                                                                                                                                                                                                                    ifelse(test_unit_cln1 %in% c("X 10*6/UL","X 10(6)/MCL","X 10^6/UL","X(10)6/UL","X MIL/UL","X10 6/UL","X10(6)/UL","X10(6)/MCL","X10^6/UL","X10E6/UL","X10E+06/UL","X10*6/UL"),"X10*6/UL",
                                                                                                                                                                                                                                                                                                           ifelse(test_unit_cln1 %in% c("MMOL/L","MMOL PER LITER","MMOLES/L"),"MMOL/L",
                                                                                                                                                                                                                                                                                                                  ifelse(test_unit_cln1 %in% c("ML/24 H","ML/24 HR","ML/24HR","ML/24HRS"),"ML/24 HR",
                                                                                                                                                                                                                                                                                                                         ifelse(test_unit_cln1 %in% c("YEARS","YEAR(S)","YR","YRS","YRS."),"YEARS",
                                                                                                                                                                                                                                                                                                                                ifelse(test_unit_cln1 %in% c("INTERNATIONAL UNITS/L","INTERNATIONAL UNITS PER LITER","INTL UNITS/L","INTLUNIT/L","IU/L","IUNITS/L"),"INTERNATIONAL UNITS/L",
                                                                                                                                                                                                                                                                                                                                       ifelse(test_unit_cln1 %in% c("INTERNATIONAL UNITS/ML","INTERNATIONAL UNITS PER MILLILITER","INTL UNITS/ML","INTLUNIT/ML","IU/ML","IUNIT/ML","IUNITS/ML"),"INTERNATIONAL UNITS/ML",
                                                                                                                                                                                                                                                                                                                                              ifelse(test_unit_cln1 %in% c("INTERNATIONAL UNITS/DL","INTERNATIONAL UNITS PER DECILITER","INTL UNITS/DL","INTLUNIT/DL","IU/DL","IUNIT/DL","IUNITS/DL"),"INTERNATIONAL UNITS/DL",
                                                                                                                                                                                                                                                                                                                                                     ifelse(test_unit_cln1 %in% c("MMOL PER 24 HR","MMOL/24 H","MMOL/24 HR","MMOL/24 HRS","MMOL/24H","MMOL/24HR","MMOL/24HRS","MMOL/D","MMOL/DAY"),"MMOL/24 H",
                                                                                                                                                                                                                                                                                                                                                            ifelse(test_unit_cln1 %in% c("X 10*3/ML","X 10(3)/ML","X 10^3/ML","X(10)3/ML","X 1000/ML","X10 3/ML","X10(3)/ML","X10(3)/ML","X10^3/ML","X1000/ML","X10E3/ML","X10E+03/ML"),"X10*3/ML",
                                                                                                                                                                                                                                                                                                                                                                   test_unit_cln1)))))))))))))))))))))))))))))))))))))))))))))))) %>%
    mutate(test_unit_cln=ifelse(test_unit_cln2 %in% c("X 10*12/L","X 10(12)/L","X 10^12/L","X(10)12/L","X10 12/L","X10(12)/L","X10(12)/L","X10^12/L","X10E12/L","X10E+012/L","X1OE+12/L"),"X10*12/L",
                                ifelse(test_unit_cln2 %in% c("ML/MIN/1.73 M2","ML/MIN 1.73/M2","ML/MIN/((173/100).M2)","ML/MIN/{1.73_M2}","ML/MIN/1. 73M2","ML/MIN/1.73","ML/MIN/1.73 M*2","ML/MIN/1.73 M?","ML/MIN/1.73 M^2","ML/MIN/1.73 MÂ¿","ML/MIN/1.73 SQ METER","ML/MIN/1.73 SQ. M","ML/MIN/1.73 SQM","ML/MIN/1.73**2","ML/MIN/1.73_M2","ML/MIN/1.73M","ML/MIN/1.73M 2","ML/MIN/1.73M(2)","ML/MIN/1.73M**2","MLS/MIN/1.73M2","ML/MIN/1.73M*2","ML/MIN/1.73M^2","ML/MIN/1.73M1","ML/MIN/1.73M2","ML/MIN/1.73M2^ML/MIN/1.73M2","ML/MIN/1.73M3","ML/MIN/1.73ME2","ML/MIN/1.73SQ M","ML/MIN/1.73SQ.M","ML/MIN/1.73SQM","MLMIN173M2","MLS/MIN/1.73M2","MIL/MIN/1.73"),"ML/MIN/1.73 M2",
                                       ifelse(test_unit_cln2 %in% c("X 10*6/ML","X 10(6)/ML","X 10^6/ML","X(10)6/ML","X MIL/ML","X10 6/ML","X10(6)/ML","X10(6)/ML","X10^6/ML","X10E6/ML","X10E+06/ML"),"X10*6/ML",
                                              ifelse(test_unit_cln2 %in% c("X 10*9/L","X 10(9)/L","X 10^9/L","X(10)9/L","X10 9/L","X10(9)/L","X10(9)/L","X10^9/L","X10E9/L","X10E+09/L","X10E+9/L","X1OE+09/L","X10*9/L"),"X10*9/L",
                                                     test_unit_cln2))))) %>%
    mutate(result_diff=ifelse(round(parse_number(LAB_RESULTS),digits=3)==round(parse_number(TEST_RESULT_NUMERIC),digits=3),"same","diff"))
}
